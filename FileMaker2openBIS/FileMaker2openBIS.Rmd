---
title: "FileMaker2openBIS"
output: html_notebook
---

```{r, include=FALSE}
library(tidyverse)
library(stringr)
```

# Files
```{r}
path = "~/Desktop/"
FileMakerRunsFile = paste0(path, "FileMakerRuns.csv")
FileMakerSamplesFile = paste0(path, "FileMakerSamples.csv")

```

# FileMaker Runs
```{r, echo=FALSE, message=FALSE}
FileMakerRuns = read_csv(FileMakerRunsFile, col_names = FALSE) %>%
        rename(DATE = X1,
               INVESTIGATOR_NAME = X2,
               ACCOUNT = X3,
               EXPERIMENT_NAME = X4,
               DESCRIPTION = X5,
               sample_sheet = X6,
               RUN_NAME = X7,
               samples = X8,
               PHIX_CONCENTRATION = X9,
               RGT_BOX_1 = X10,
               RGT_BOX_2 = X11,
               READ_1 = X12,
               READ_2 = X13,
               kit = X14) %>%
        
        filter(!(grepl("Extern", ACCOUNT))) %>%
        
        mutate(new_project = case_when(
                ACCOUNT == "KFSP Virome" ~ "METAGENOMICS",
                INVESTIGATOR_NAME == "Merle Schanz" ~ "ANTIBODIES",
                INVESTIGATOR_NAME == "Cyril Shah" ~ "RESISTANCE",
                INVESTIGATOR_NAME == "Natacha Espirito Santo" ~ "PLASMIDS",
                TRUE ~ "OTHER"
                )) %>%
        
        mutate(identifier = paste0(RUN_NAME,"_", new_project),
               container = "",
               parents = "",
               experiment = paste0("/IMV/", new_project,"/MISEQ_RUNS"),
               default_space = "IMV",
               MISEQ_WORKFLOW = "",
               APPLICATION = "",
               ASSAY = "",
               CHEMISTRY = "",
               Tags = "FileMaker") %>%
        
        select(identifier, container, parents, experiment, default_space, INVESTIGATOR_NAME, EXPERIMENT_NAME, RUN_NAME, ACCOUNT, DATE,
               MISEQ_WORKFLOW, APPLICATION, ASSAY, DESCRIPTION, CHEMISTRY, READ_1, READ_2, PHIX_CONCENTRATION, RGT_BOX_1, RGT_BOX_2)

FileMakerRuns[is.na(FileMakerRuns)] = ""

FileMakerRuns
```
### Write runs upload file
```{r, echo=FALSE, message=FALSE}
FileMakerRuns %>%   
        filter(experiment == "/IMV/ANTIBODIES/MISEQ_RUNS") %>%
        sample_n(1) %>%
        write_tsv(., paste0(path, "SAMPLE_MISEQ-RUN.tsv"))
```

# FileMaker Samples
```{r, echo=FALSE, message=FALSE}
FileMakerSamples = read_csv(FileMakerSamplesFile, col_names = FALSE) %>%
        rename(RUN_NAME = X1,
               sample_sheet = X2,
               SAMPLE_ID = X3,
               SAMPLE_NAME = X4,
               DESCRIPTION = X5,
               I7_INDEX_ID = X6,
               I5_INDEX_ID = X7,
               sample_project = X8) %>%

        mutate(SAMPLE_NAME = ifelse((!(is.na(as.numeric(SAMPLE_ID)) | as.numeric(SAMPLE_ID) > 96)), SAMPLE_NAME, paste(SAMPLE_NAME,SAMPLE_ID))) %>%
        mutate(id_from_id = ifelse((!(is.na(as.numeric(SAMPLE_ID)) | as.numeric(SAMPLE_ID) > 96)), SAMPLE_ID, NA)) %>%
        mutate(id_from_name = str_extract(str_extract(SAMPLE_NAME, "_S[0-9]+_L"), "[0-9]+")) %>%
        group_by(sample_sheet) %>%
        mutate(id_by_ss = row_number()) %>%
        mutate(final_id = case_when(
                !(is.na(id_from_name)) ~ id_from_name,
                !(is.na(id_from_id)) ~ id_from_id,
                TRUE ~ as.character(id_by_ss)
                )) %>%
        mutate(SAMPLE_ID = final_id) %>%
        
        left_join(., FileMakerRuns[, c("RUN_NAME", "experiment")], by = "RUN_NAME") %>%
        
        mutate(identifier = paste0(RUN_NAME,"-", SAMPLE_ID),
               container = "",
               parents = paste0(RUN_NAME,"_", unlist(strsplit(experiment, "/"))[3]),
               experiment = sub("/MISEQ_RUNS", "/MISEQ_SAMPLES", experiment),
               default_space = "IMV",
               SAMPLE_PLATE = "",
               SAMPLE_WELL = "",
               INDEX_1 = "",
               INDEX_2 = "",
               Tags = "FileMaker") %>%
        
        select(identifier, container, parents, experiment, default_space, SAMPLE_ID, SAMPLE_NAME, SAMPLE_PLATE, SAMPLE_WELL, INDEX_1, INDEX_2, I7_INDEX_ID, I5_INDEX_ID, DESCRIPTION)

FileMakerSamples
```

### Write samples upload file
```{r, echo=FALSE, message=FALSE}
FileMakerSamples %>%   
        filter(experiment == "/IMV/ANTIBODIES/MISEQ_SAMPLES") %>%
        sample_n(1) %>%
        write_tsv(., paste0(path, "SAMPLE_MISEQ-SAMPLE.tsv"))
```
